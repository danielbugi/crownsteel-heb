generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String    @id @default(cuid())
  name             String?
  email            String    @unique
  emailVerified    DateTime?
  image            String?
  hashedPassword   String
  role             Role      @default(USER)
  resetToken       String?   @unique
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  accounts       Account[]
  sessions       Session[]
  orders         Order[]
  cartItems      CartItem[]
  reviews        Review[]
  wishlist       Wishlist[]
  supportTickets SupportTicket[] @relation("CustomerTickets")
  blogPosts      BlogPost[]      @relation("BlogAuthor")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verificationtokens")
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@map("categories")
}

model Product {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique
  description       String?  @db.Text
  price             Decimal  @db.Decimal(10, 2)
  comparePrice      Decimal? @db.Decimal(10, 2)
  image             String
  images            String[]
  inStock           Boolean  @default(true)
  featured          Boolean  @default(false)
  freeShipping      Boolean  @default(false)
  inventory         Int      @default(0)
  categoryId        String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  averageRating     Decimal? @db.Decimal(3, 2)
  reviewCount       Int      @default(0)
  lowStockThreshold Int      @default(10) // Alert when stock falls below this
  reorderPoint      Int      @default(20) // Suggested reorder point
  reorderQuantity   Int      @default(50) // Suggested reorder quantity
  sku               String?  @unique // Stock Keeping Unit

  // Variant settings
  hasVariants  Boolean @default(false) // Does this product have variants?
  variantType  String? // "Size", "Length", "Width", etc (what to call it)
  variantLabel String? // Display label (e.g., "Ring Size", "Chain Length")

  category          Category           @relation(fields: [categoryId], references: [id])
  cartItems         CartItem[]
  orderItems        OrderItem[]
  reviews           Review[]
  wishlists         Wishlist[]
  inventoryLogs     InventoryLog[]
  inventoryAlerts   InventoryAlert[]
  stockReservations StockReservation[]
  variants          ProductVariant[]

  // Performance indexes for common queries
  @@index([categoryId]) // Fast category filtering
  @@index([featured]) // Fast featured product queries  
  @@index([inStock]) // Fast stock filtering
  @@index([createdAt]) // Fast sorting by date
  @@index([categoryId, featured]) // Fast featured products in category
  @@index([categoryId, inStock]) // Fast in-stock products in category
  @@index([featured, inStock]) // Fast featured + in-stock queries
  @@index([featured, inStock, categoryId]) // Optimal composite for shop page filters
  @@map("products")
}

model ProductVariant {
  id        String @id @default(cuid())
  productId String

  // Simple variant data
  name String // "50cm", "9", "Medium", etc
  sku  String @unique

  // Pricing (optional, falls back to product price if not set)
  price           Decimal? @db.Decimal(10, 2) // NULL = use product price
  priceAdjustment Decimal? @db.Decimal(10, 2) // e.g., +20 for larger sizes

  // Inventory (each variant has its own stock)
  inventory Int     @default(0)
  inStock   Boolean @default(true)

  // Low stock settings (inherits from product if not set)
  lowStockThreshold Int?

  // Display
  image     String? // Optional: variant-specific image
  sortOrder Int     @default(0) // Display order (0, 1, 2, 3...)
  isDefault Boolean @default(false) // Default selected variant

  // Tracking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product         Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems       CartItem[]       @relation("VariantCartItems")
  orderItems      OrderItem[]      @relation("VariantOrderItems")
  inventoryLogs   InventoryLog[]   @relation("VariantInventoryLogs")
  inventoryAlerts InventoryAlert[] @relation("VariantInventoryAlerts")

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  variantId String? // ADD THIS LINE
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation("VariantCartItems", fields: [variantId], references: [id], onDelete: SetNull)

  @@unique([userId, productId])
  @@map("cart_items")
}

model Order {
  id     String      @id @default(cuid())
  userId String?
  status OrderStatus @default(PENDING)

  subtotal   Decimal? @db.Decimal(10, 2)
  discount   Decimal? @db.Decimal(10, 2)
  couponId   String?
  couponCode String?

  total           Decimal  @db.Decimal(10, 2)
  shippingAddress Json
  billingAddress  Json?
  paymentIntentId String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user       User?       @relation(fields: [userId], references: [id])
  orderItems OrderItem[]

  coupon Coupon? @relation("CouponOrders", fields: [couponId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([couponId])
  @@index([userId, status, createdAt]) // Composite index for common admin queries
  @@map("orders")
}

model OrderItem {
  id              String  @id @default(cuid())
  orderId         String
  productId       String
  variantId       String? // NEW: NULL if product has no variants
  quantity        Int
  price           Decimal @db.Decimal(10, 2)
  variantSnapshot Json? // NEW: {name: "50cm", sku: "CHAIN-FG-50"}

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation("VariantOrderItems", fields: [variantId], references: [id], onDelete: SetNull)

  @@map("order_items")
}

model Settings {
  id              String  @id @default(cuid())
  siteName        String  @default("Forge & Steel")
  siteDescription String  @default("Premium Men's Jewelry")
  contactEmail    String  @default("contact@forgesteel.com")
  contactPhone    String  @default("+972-50-123-4567")
  address         String  @default("Online E-commerce Store")
  currency        String  @default("ILS")
  currencySymbol  String  @default("â‚ª")
  taxRate         Decimal @default(18) @db.Decimal(5, 2)

  // Email Settings
  smtpFromEmail             String  @default("contact@forgesteel.com")
  smtpReplyToEmail          String?
  emailNotificationsEnabled Boolean @default(true)
  adminNotificationEmail    String  @default("admin@forgesteel.com")

  // Shipping Settings
  shippingCost          Decimal @default(20) @db.Decimal(10, 2)
  freeShippingThreshold Decimal @default(350) @db.Decimal(10, 2)
  shippingDescription   String  @default("Standard shipping within Israel")
  processingTime        String  @default("2-3 business days")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId]) // Prevent duplicates
  @@index([userId]) // Fast user queries
  @@index([productId]) // Fast product queries
  @@map("wishlists")
}

model Review {
  id        String       @id @default(cuid())
  productId String
  userId    String
  rating    Int // 1-5 stars
  title     String?
  comment   String?      @db.Text
  verified  Boolean      @default(false) // Verified purchase
  helpful   Int          @default(0) // Helpful count
  status    ReviewStatus @default(PENDING)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId]) // One review per user per product
  @@index([productId])
  @@index([userId])
  @@index([status, createdAt]) // For admin review management
  @@map("reviews")
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum CampaignType {
  NEWSLETTER_WELCOME
  FIRST_ORDER
  BLACK_FRIDAY
  HOLIDAY
  FLASH_SALE
  ABANDONED_CART
  BIRTHDAY
  REFERRAL
  CUSTOM
}

model InventoryLog {
  id          String              @id @default(cuid())
  productId   String
  variantId   String? // NEW: Track which variant changed (NULL for non-variant products)
  type        InventoryChangeType
  quantity    Int // Positive for additions, negative for reductions
  reason      String?
  reference   String? // Order ID, adjustment ID, etc.
  previousQty Int
  newQty      Int
  createdBy   String? // Admin user ID
  createdAt   DateTime            @default(now())

  variant ProductVariant? @relation("VariantInventoryLogs", fields: [variantId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([createdAt])
  @@map("inventory_logs")
}

model InventoryAlert {
  id             String    @id @default(cuid())
  productId      String
  type           AlertType
  threshold      Int? // Low stock threshold
  variantId      String?
  message        String
  acknowledged   Boolean   @default(false)
  acknowledgedBy String? // Admin user ID
  acknowledgedAt DateTime?
  createdAt      DateTime  @default(now())

  variant ProductVariant? @relation("VariantInventoryAlerts", fields: [variantId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([acknowledged])
  @@index([createdAt])
  @@map("inventory_alerts")
}

model StockReservation {
  id        String            @id @default(cuid())
  productId String
  quantity  Int
  orderId   String? // If associated with an order
  expiresAt DateTime // Auto-release after expiration
  status    ReservationStatus @default(ACTIVE)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([expiresAt])
  @@index([status])
  @@map("stock_reservations")
}

enum InventoryChangeType {
  SALE // Sold to customer
  RETURN // Customer return
  ADJUSTMENT // Manual adjustment
  RESTOCK // New stock added
  DAMAGE // Damaged goods
  LOSS // Lost/stolen
  RESERVATION // Reserved for order
  RELEASE // Released reservation
}

enum AlertType {
  LOW_STOCK // Below threshold
  OUT_OF_STOCK // Zero inventory
  OVERSTOCK // Too much inventory
  EXPIRING_RESERVATION // Reservation about to expire
}

enum ReservationStatus {
  ACTIVE // Currently reserved
  COMPLETED // Order completed
  EXPIRED // Reservation expired
  CANCELLED // Order cancelled
}

model PerformanceMetric {
  id        String   @id @default(cuid())
  endpoint  String
  method    String
  duration  Int
  status    Int
  timestamp DateTime @default(now())

  @@index([endpoint])
  @@index([timestamp])
  @@map("performance_metrics")
}

model WebVitalsMetric {
  id             String   @id @default(cuid())
  name           String // CLS, FID, FCP, LCP, TTFB, INP
  value          Float
  rating         String // good, needs-improvement, poor
  metricId       String // Unique ID from browser
  navigationType String
  timestamp      DateTime @default(now())

  @@index([name])
  @@index([timestamp])
  @@index([rating])
  @@map("web_vitals_metrics")
}

model Newsletter {
  id         String   @id @default(cuid())
  email      String   @unique
  subscribed Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  coupons    Coupon[]

  @@index([subscribed])
  @@index([createdAt])
  @@map("newsletters")
}

model Coupon {
  id          String  @id @default(cuid())
  code        String  @unique
  description String?

  // Discount settings
  discountType  DiscountType
  discountValue Decimal      @db.Decimal(10, 2)

  // Restrictions
  minPurchase Decimal? @db.Decimal(10, 2)
  maxDiscount Decimal? @db.Decimal(10, 2)

  // Usage limits
  usageLimit   Int?
  usageCount   Int  @default(0)
  usagePerUser Int? @default(1)

  // Validity
  validFrom DateTime  @default(now())
  validTo   DateTime?
  active    Boolean   @default(true)

  // Campaign tracking
  campaignType CampaignType?
  newsletterId String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?

  // Relations
  newsletter Newsletter? @relation(fields: [newsletterId], references: [id], onDelete: SetNull)
  orders     Order[]     @relation("CouponOrders")

  @@index([code])
  @@index([active])
  @@index([validFrom, validTo])
  @@index([campaignType])
  @@map("coupons")
}

// Blog System Models
model BlogCategory {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  posts BlogPost[]

  @@index([slug])
  @@map("blog_categories")
}

model BlogPost {
  id      String  @id @default(cuid())
  title   String
  slug    String  @unique
  excerpt String? @db.Text
  content String  @db.Text

  // SEO fields
  metaTitle       String?
  metaDescription String?  @db.Text
  keywords        String[] // Array of keywords

  // Media
  featuredImage String?
  images        String[]

  // Publishing
  status      BlogStatus @default(DRAFT)
  publishedAt DateTime?

  // Organization
  categoryId String
  featured   Boolean @default(false)

  // Author
  authorId   String
  authorName String? // Cached author name

  // Engagement
  views    Int  @default(0)
  readTime Int? // Estimated read time in minutes

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  category BlogCategory  @relation(fields: [categoryId], references: [id])
  author   User          @relation("BlogAuthor", fields: [authorId], references: [id])
  tags     BlogPostTag[]

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([categoryId])
  @@index([authorId])
  @@index([featured])
  @@index([status, publishedAt])
  @@map("blog_posts")
}

model BlogTag {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())

  posts BlogPostTag[]

  @@index([slug])
  @@map("blog_tags")
}

model BlogPostTag {
  id        String   @id @default(cuid())
  postId    String
  tagId     String
  createdAt DateTime @default(now())

  post BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  BlogTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
  @@map("blog_post_tags")
}

enum BlogStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model SupportTicket {
  id          String   @id @default(cuid())
  customerId  String
  customer    User     @relation("CustomerTickets", fields: [customerId], references: [id], onDelete: Cascade)
  subject     String
  description String
  status      String   @default("open") // open, in-progress, resolved, closed
  priority    String   @default("medium") // low, medium, high
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([customerId])
  @@index([status])
}
